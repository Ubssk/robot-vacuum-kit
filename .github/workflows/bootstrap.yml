name: Bootstrap Repo
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate repository files
        shell: bash
        run: |
          set -euo pipefail

          REPO_ROOT="$PWD"

          mkdir -p openapi infra docs tests/e2e/postman tests/integration \
                   csharp/src/VendorConnector csharp/tests/Unit csharp/tests/Integration \
                   csharp/src/VendorConnector/Controllers csharp/src/VendorConnector/Services \
                   java/vendor-connector/src/main/java/com/example/vendor/api \
                   java/vendor-connector/src/main/java/com/example/vendor/service \
                   java/vendor-connector/src/main/resources \
                   java/vendor-connector/src/test/java/com/example/vendor/api \
                   java/vendor-connector/src/test/java/com/example/vendor/service \
                   js/vendor-connector/src js/vendor-connector/test \
                   .github/workflows

          cat > .gitignore <<'EOF'
          .DS_Store
          Thumbs.db
          node_modules
          npm-debug.log
          yarn.lock
          pnpm-lock.yaml
          bin/
          obj/
          TestResults/
          *.user
          *.suo
          target/
          .mvn/wrapper/maven-wrapper.jar
          .mvn/wrapper/maven-wrapper.properties
          coverage/
          tests/reports/
          EOF

          cat > README.md <<'EOF'
          Robot Vacuum Kit (C#, Java, JS)
          Сервисы: Vendor Connector на трех языках. Внутри: /health, /metrics, эндпоинт политики прошивок, unit и integration тесты, OpenAPI, docker-compose для локального запуска, Prometheus+Grafana.

          Быстрый старт
          - Требуется Docker/Docker Compose.
          - Запуск всего стека:
            docker compose up -d --build
          - Проверка:
            - C# http://localhost:5000/health/ready и /metrics
            - Java http://localhost:8081/actuator/health/readiness и /actuator/prometheus
            - JS http://localhost:8082/health/ready и /metrics
            - Prometheus http://localhost:9090
            - Grafana http://localhost:3000 (admin/admin)

          Тесты
          - Unit:
            - C#: dotnet test csharp
            - Java: mvn -q -f java/vendor-connector/pom.xml test
            - JS: (в каталоге js/vendor-connector) npm test
          - Интеграционные (против запущенных сервисов):
            - cd tests/integration && npm i && npm test
          - E2E (Postman/Newman):
            - newman run tests/e2e/postman/collection.json -e tests/e2e/postman/environment.json
          EOF

          cat > openapi/api-v1.yaml <<'EOF'
          openapi: 3.0.3
          info:
            title: Robot Vacuum Cloud API
            version: 1.0.0
          servers:
            - url: http://localhost
          paths:
            /health/live:
              get:
                responses:
                  "200": { description: OK }
            /health/ready:
              get:
                responses:
                  "200": { description: OK }
                  "503": { description: Not Ready }
            /firmware/can-update:
              get:
                parameters:
                  - in: query
                    name: now
                    schema: { type: string, example: "03:30" }
                  - in: query
                    name: window
                    schema: { type: string, example: "22:00-04:00" }
                responses:
                  "200":
                    description: Result
                    content:
                      application/json:
                        schema:
                          type: object
                          properties:
                            canUpdate:
                              type: boolean
          EOF

          cat > docker-compose.yml <<'EOF'
          services:
            csharp:
              build: ./csharp/src/VendorConnectorcontainer_name: csharp
              ports: [ "5000:5000" ]
            java:
              build: ./java/vendor-connector
              container_name: java
              ports: [ "8081:8081" ]
            js:
              build: ./js/vendor-connector
              container_name: js
              ports: [ "8082:8082" ]
            prometheus:
              image: prom/prometheus:latest
              container_name: prometheus
              volumes:
                - ./infra/prometheus.yml:/etc/prometheus/prometheus.yml:ro
              ports: [ "9090:9090" ]
              depends_on: [ csharp, java, js ]
            grafana:
              image: grafana/grafana:latest
              container_name: grafana
              environment:
                - GF_SECURITY_ADMIN_PASSWORD=admin
                - GF_SECURITY_ADMIN_USER=admin
              ports: [ "3000:3000" ]
              depends_on: [ prometheus ]
          EOF

          cat > infra/prometheus.yml <<'EOF'
          global:
            scrape_interval: 10s
          scrape_configs:
            - job_name: csharp
              static_configs:
                - targets: [ "csharp:5000" ]
              metrics_path: /metrics
            - job_name: java
              static_configs:
                - targets: [ "java:8081" ]
              metrics_path: /actuator/prometheus
            - job_name: js
              static_configs:
                - targets: [ "js:8082" ]
              metrics_path: /metrics
          EOF

          cat > tests/e2e/postman/environment.json <<'EOF'
          {
            "id": "robot-env",
            "name": "local",
            "values": [
              { "key": "csharpBase", "value": "http://localhost:5000", "enabled": true },
              { "key": "javaBase",   "value": "http://localhost:8081", "enabled": true },
              { "key": "jsBase",     "value": "http://localhost:8082", "enabled": true }
            ],
            "_postman_variable_scope": "environment"
          }
          EOF

          cat > tests/e2e/postman/collection.json <<'EOF'
          {
            "info": { "name": "Robot Vacuum E2E", "_postman_id": "rv-e2e", "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json" },
            "item": [
              { "name": "C# Ready",   "request": { "method": "GET", "url": "{{csharpBase}}/health/ready" }, "event": [{ "listen":"test","script":{"exec":["pm.test('200',()=>pm.response.to.have.status(200));"]}}]},
              { "name": "Java Ready", "request": { "method": "GET", "url": "{{javaBase}}/actuator/health/readiness" }, "event": [{ "listen":"test","script":{"exec":["pm.test('200',()=>pm.response.to.have.status(200));"]}}]},
              { "name": "JS Ready",   "request": { "method": "GET", "url": "{{jsBase}}/health/ready" }, "event": [{ "listen":"test","script":{"exec":["pm.test('200',()=>pm.response.to.have.status(200));"]}}]},
              { "name": "JS CanUpdate", "request": { "method": "GET", "url": "{{jsBase}}/firmware/can-update?now=03:30&window=22:00-04:00" }, "event": [{ "listen":"test","script":{"exec":[
                "pm.test('200',()=>pm.response.to.have.status(200));",
                "pm.test('canUpdate true',()=>pm.expect(pm.response.json().canUpdate).to.eql(true));"
              ]}}]}
            ]
          }
          EOF

          cat > tests/integration/package.json <<'EOF'
          {
            "name": "integration-tests",
            "version": "1.0.0",
            "type": "module",
            "scripts": {
              "test": "jest --runInBand --testTimeout=60000"
            },
            "dependencies": {
              "got": "^14.4.1"
            },
            "devDependencies": {
              "jest": "^29.7.0"
            }
          }
          EOF

          cat > tests/integration/jest.config.json <<'EOF'
          {
            "testEnvironment": "node"
          }
          EOF

          cat > tests/integration/test/services.integration.test.js <<'EOF'
          import got from "got";

          const endpoints = [
            { name: "csharp ready", url: "http://localhost:5000/health/ready", expect: 200 },
            { name: "java ready",   url: "http://localhost:8081/actuator/health/readiness", expect: 200 },
            { name: "js ready",     url: "http://localhost:8082/health/ready", expect: 200 },
            { name: "js can-update",url: "http://localhost:8082/firmware/can-update?now=03:30&window=22:00-04:00", expect: 200, jsonKey: "canUpdate", jsonVal: true },
            { name: "csharp metrics", url: "http://localhost:5000/metrics", expect: 200, contains: "process_cpu_seconds_total" },
            { name: "java metrics",   url: "http://localhost:8081/actuator/prometheus", expect: 200, contains: "jvm_memory_bytes_used" },
            { name: "js metrics",     url: "http://localhost:8082/metrics", expect: 200, contains: "process_cpu_user_seconds_total" }
          ];

          async function waitForOk(url, attempts=30, delayMs=1000){
            for(let i=0;i<attempts;i++){
              try {
                const res = await got(url, { throwHttpErrors: false, retry: 0 });
                if (res.statusCode === 200) return true;
              } catch {}
              await new Promise(r=>setTimeout(r, delayMs));
            }
            return false;
          }

          describe("services integration", () => {
            beforeAll(async () => {
              const ok = await Promise.all([
                waitForOk("http://localhost:5000/health/ready"),
                waitForOk("http://localhost:8081/actuator/health/readiness"),
                waitForOk("http://localhost:8082/health/ready")
              ]);
              if (ok.some(v=>!v)) throw new Error("Services not ready. Start: docker compose up -d --build");
            });

            it.each(endpoints)("$name", async ({url, expect, jsonKey, jsonVal, contains}) => {
              const res = await got(url, { throwHttpErrors: false, retry: 0 });
              expect(res.statusCode).toBe(expect);
              if (jsonKey){
                const body = JSON.parse(res.body);
                expect(body[jsonKey]).toBe(jsonVal);
              }
              if (contains){
                expect(res.body).toContain(contains);
              }
            });
          });
          EOF

          # C# service
          cat > csharp/src/VendorConnector/VendorConnector.csproj <<'EOF'
          <Project Sdk="Microsoft.NET.Sdk.Web">
            <PropertyGroup>
              <TargetFramework>net8.0</TargetFramework>
              <Nullable>enable</Nullable>
              <ImplicitUsings>enable</ImplicitUsings>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="prometheus-net.AspNetCore" Version="8.0.0" />
            </ItemGroup>
          </Project>
          EOF

          cat > csharp/src/VendorConnector/Program.cs <<'EOF'
          using Microsoft.AspNetCore.Builder;
          using Microsoft.Extensions.DependencyInjection;
          using Microsoft.Extensions.Diagnostics.HealthChecks;
          using Prometheus;

          var builder = WebApplication.CreateBuilder(args);
          builder.Services.AddControllers();
          builder.Services.AddHealthChecks()
              .AddCheck("self", () => HealthCheckResult.Healthy())
              .AddCheck("postgres", () => HealthCheckResult.Healthy(), tags: new[] { "ready" })
              .AddCheck("redis", () => HealthCheckResult.Healthy(), tags: new[] { "ready" });

          var app = builder.Build();

          app.MapGet("/health/live", () => Results.Ok(new { status = "ok" }));
          app.MapGet("/health/ready", async (HealthCheckService hc) =>
          {
              var report = await hc.CheckHealthAsync(r => r.Tags.Contains("ready"));
              return report.Status == HealthStatus.Healthy
                  ? Results.Ok(new { status = "ok" })
                  : Results.StatusCode(503);
          });
          app.MapControllers();
          app.UseHttpMetrics();
          app.MapMetrics("/metrics");
          app.Run();

          public partial class Program { }EOF

          cat > csharp/src/VendorConnector/Controllers/HealthController.cs <<'EOF'
          using Microsoft.AspNetCore.Mvc;

          namespace VendorConnector.Controllers
          {
              [ApiController]
              [Route("firmware")]
              public class HealthController : ControllerBase
              {
                  [HttpGet("can-update")]
                  public IActionResult CanUpdate([FromQuery] string now = "03:30", [FromQuery] string window = "22:00-04:00")
                  {
                      var ok = Services.FirmwarePolicy.CanUpdate(now, window);
                      return Ok(new { canUpdate = ok });
                  }
              }
          }
          EOF

          cat > csharp/src/VendorConnector/Services/FirmwarePolicy.cs <<'EOF'
          using System;

          namespace VendorConnector.Services
          {
              public static class FirmwarePolicy
              {
                  public static bool CanUpdate(string nowLocal, string window)
                  {
                      var parts = window.Split('-');
                      var from = TimeSpan.Parse(parts[0]);
                      var to   = TimeSpan.Parse(parts[1]);
                      var now  = TimeSpan.Parse(nowLocal);
                      if (from <= to) return now >= from && now <= to;
                      return now >= from || now <= to;
                  }

                  public static int SemverCmp(string a, string b)
                  {
                      var pa = a.Split('.');
                      var pb = b.Split('.');
                      for (int i = 0; i < 3; i++)
                      {
                          int ai = int.Parse(pa[i]);
                          int bi = int.Parse(pb[i]);
                          if (ai != bi) return ai.CompareTo(bi);
                      }
                      return 0;
                  }
              }
          }
          EOF

          cat > csharp/tests/Unit/Unit.csproj <<'EOF'
          <Project Sdk="Microsoft.NET.Sdk">
            <PropertyGroup>
              <TargetFramework>net8.0</TargetFramework>
              <IsPackable>false</IsPackable>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.11.1" />
              <PackageReference Include="xunit" Version="2.9.0" />
              <PackageReference Include="xunit.runner.visualstudio" Version="2.8.2">
                <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
                <PrivateAssets>all</PrivateAssets>
              </PackageReference>
              <PackageReference Include="coverlet.collector" Version="6.0.2">
                <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
                <PrivateAssets>all</PrivateAssets>
              </PackageReference>
            </ItemGroup>
            <ItemGroup>
              <ProjectReference Include="../../src/VendorConnector/VendorConnector.csproj" />
            </ItemGroup>
          </Project>
          EOF

          cat > csharp/tests/Unit/FirmwarePolicyTests.cs <<'EOF'
          using VendorConnector.Services;
          using Xunit;

          public class FirmwarePolicyTests
          {
              [Fact]
              public void WindowAcrossMidnight()
              {
                  Assert.True(FirmwarePolicy.CanUpdate("03:30", "22:00-04:00"));
                  Assert.False(FirmwarePolicy.CanUpdate("21:59", "22:00-04:00"));
              }

              [Fact]
              public void SemverCompare()
              {
                  Assert.True(FirmwarePolicy.SemverCmp("1.2.10","1.2.9") > 0);
                  Assert.True(FirmwarePolicy.SemverCmp("1.2.0","1.2.0") == 0);
                  Assert.True(FirmwarePolicy.SemverCmp("1.2.0","1.3.0") < 0);
              }
          }
          EOF

          cat > csharp/tests/Integration/Integration.csproj <<'EOF'
          <Project Sdk="Microsoft.NET.Sdk">
            <PropertyGroup>
              <TargetFramework>net8.0</TargetFramework>
              <IsPackable>false</IsPackable>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="Microsoft.AspNetCore.Mvc.Testing" Version="8.0.10" />
              <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.11.1" />
              <PackageReference Include="xunit" Version="2.9.0" />
              <PackageReference Include="xunit.runner.visualstudio" Version="2.8.2">
                <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
                <PrivateAssets>all</PrivateAssets>
              </PackageReference>
            </ItemGroup>
            <ItemGroup>
              <ProjectReference Include="../../src/VendorConnector/VendorConnector.csproj" />
            </ItemGroup>
          </Project>
          EOF

          cat > csharp/tests/Integration/HealthEndpointsTests.cs <<'EOF'
          using System.Net.Http.Json;
          using Microsoft.AspNetCore.Mvc.Testing;
          using Xunit;

          public class HealthEndpointsTests : IClassFixture<WebApplicationFactory<Program>>
          {
              private readonly HttpClient _client;

              public HealthEndpointsTests(WebApplicationFactory<Program> factory)
              {
                  _client = factory.CreateClient();
              }

              [Fact]
              public async Task Ready_ReturnsOk()
              {
                  var res = await _client.GetAsync("/health/ready");
                  Assert.True(res.IsSuccessStatusCode);
              }

              [Fact]
              public async Task CanUpdate_ReturnsTrue()
              {
                  var res = await _client.GetFromJsonAsync<dynamic>("/firmware/can-update?now=03:30&window=22:00-04:00");
                  Assert.True((bool)res.canUpdate);
              }
          }
          EOF

          cat > csharp/src/VendorConnector/Dockerfile <<'EOF'
          FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
          WORKDIR /src
          COPY . .
          RUN dotnet publish -c Release -o /app

          FROM mcr.microsoft.com/dotnet/aspnet:8.0
          WORKDIR /app
          COPY --from=build /app .
          ENV ASPNETCORE_URLS=http://0.0.0.0:5000
          EXPOSE 5000
          ENTRYPOINT ["dotnet","VendorConnector.dll"]
          EOF

          # Java
          cat > java/vendor-connector/pom.xml <<'EOF'
          <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.example</groupId>
            <artifactId>vendor-connector</artifactId>
            <version>0.0.1-SNAPSHOT</version>
            <properties>
              <java.version>21</java.version>
              <spring.boot.version>3.3.4</spring.boot.version>
            </properties>
            <dependencies>
              <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-web</artifactId>
                <version>${spring.boot.version}</version>
              </dependency>
              <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-actuator</artifactId>
                <version>${spring.boot.version}</version>
              </dependency>
              <dependency>
                <groupId>io.micrometer</groupId>
                <artifactId>micrometer-registry-prometheus</artifactId>
                <version>1.13.3</version>
              </dependency>
              <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-test</artifactId>
                <version>${spring.boot.version}</version>
                <scope>test</scope>
              </dependency>
            </dependencies>
            <build>
              <plugins>
                <plugin>
                  <groupId>org.springframework.boot</groupId>
                  <artifactId>spring-boot-maven-plugin</artifactId>
                  <version>${spring.boot.version}</version>
                </plugin>
              </plugins>
            </build>
          </project>
          EOF

          cat > java/vendor-connector/src/main/resources/application.yml <<'EOF'
          management:
            endpoints:
              web:
                exposure:
                  include: health, prometheus
            endpoint:
              health:
                probes:
                  enabled: true
          server:
            port: 8081
          EOF

          cat > java/vendor-connector/src/main/java/com/example/vendor/Application.java <<'EOF'
          package com.example.vendor;
          import org.springframework.boot.SpringApplication;
          import org.springframework.boot.autoconfigure.SpringBootApplication;

          @SpringBootApplication
          public class Application {
            public static void main(String[] args) { SpringApplication.run(Application.class, args); }
          }
          EOF

          cat > java/vendor-connector/src/main/java/com/example/vendor/api/HealthController.java <<'EOF'
          package com.example.vendor.api;
          import com.example.vendor.service.FirmwarePolicy;
          import org.springframework.web.bind.annotation.*;

          @RestController
          @RequestMapping("/firmware")
          public class HealthController {
            @GetMapping("/can-update")
            public Object canUpdate(@RequestParam String now, @RequestParam String window) {
              boolean ok = FirmwarePolicy.canUpdate(now, window);
              return java.util.Map.of("canUpdate", ok);
            }
          }
          EOF

          cat > java/vendor-connector/src/main/java/com/example/vendor/service/FirmwarePolicy.java <<'EOF'
          package com.example.vendor.service;
          public class FirmwarePolicy {
            public static boolean canUpdate(String nowLocal, String window) {
              String[] p = window.split("-");
              java.time.LocalTime from = java.time.LocalTime.parse(p[0]);
              java.time.LocalTime to   = java.time.LocalTime.parse(p[1]);
              java.time.LocalTime now  = java.time.LocalTime.parse(nowLocal);
              if (!from.isAfter(to)) return !now.isBefore(from) && !now.isAfter(to);
              return !now.isBefore(from) || !now.isAfter(to);
            }
            public static int semverCmp(String a, String b) {
              String[] pa = a.split("\\.");
              String[] pb = b.split("\\.");
              for (int i=0;i<3;i++){
                int ai = Integer.parseInt(pa[i]);
                int bi = Integer.parseInt(pb[i]);
                if (ai!=bi) return Integer.compare(ai, bi);
              }
              return 0;
            }
          }
          EOF

          cat > java/vendor-connector/src/test/java/com/example/vendor/service/FirmwarePolicyTest.java <<'EOF'
          package com.example.vendor.service;
          import org.junit.jupiter.api.Test;
          import static org.junit.jupiter.api.Assertions.*;

          public class FirmwarePolicyTest {
            @Test void windowAcrossMidnight() {
              assertTrue(FirmwarePolicy.canUpdate("03:30","22:00-04:00"));
              assertFalse(FirmwarePolicy.canUpdate("21:59","22:00-04:00"));
            }
            @Test void semverCompare() {
              assertTrue(FirmwarePolicy.semverCmp("1.2.10","1.2.9") > 0);
              assertEquals(0, FirmwarePolicy.semverCmp("1.2.0","1.2.0"));
              assertTrue(FirmwarePolicy.semverCmp("1.2.0","1.3.0") < 0);
            }
          }
          EOF

          cat > java/vendor-connector/src/test/java/com/example/vendor/api/ApiIntegrationTest.java <<'EOF'
          package com.example.vendor.api;
          import com.example.vendor.Application;
          import org.junit.jupiter.api.Test;
          import org.springframework.beans.factory.annotation.Autowired;
          import org.springframework.boot.test.context.SpringBootTest;
          import org.springframework.boot.test.web.client.TestRestTemplate;
          import org.springframework.boot.test.web.server.LocalServerPort;
          import static org.assertj.core.api.Assertions.assertThat;

          @SpringBootTest(classes = Application.class, webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
          public class ApiIntegrationTest {
            @LocalServerPort private int port;
            @Autowired private TestRestTemplate rest;

            @Test
            void readinessOk() {
              var res = rest.getForEntity("http://localhost:"+port+"/actuator/health/readiness", String.class);
              assertThat(res.getStatusCode().value()).isEqualTo(200);
            }

            @Test
            void canUpdateOk() {
              var res = rest.getForEntity("http://localhost:"+port+"/firmware/can-update?now=03:30&window=22:00-04:00", String.class);
              assertThat(res.getStatusCode().value()).isEqualTo(200);
              assertThat(res.getBody()).contains("\"canUpdate\":true");
            }
          }
          EOF

          cat > java/vendor-connector/Dockerfile <<'EOF'
          FROM maven:3.9-eclipse-temurin-21 as build
          WORKDIR /build
          COPY pom.xml .
          RUN mvn -q -DskipTests package || true
          COPY src ./src
          RUN mvn -q -DskipTests package

          FROM eclipse-temurin:21-jre
          WORKDIR /app
          COPY --from=build /build/target/vendor-connector-0.0.1-SNAPSHOT.jar app.jar
          EXPOSE 8081
          ENTRYPOINT ["java","-jar","/app/app.jar"]
          EOF

          # JS
          cat > js/vendor-connector/package.json <<'EOF'
          {
            "name": "vendor-connector",
            "version": "1.0.0",
            "type": "module",
            "scripts": {
              "start": "node src/index.js",
              "test": "jest --runInBand"
            },
            "dependencies": {
              "fastify": "^4.28.1",
              "prom-client": "^14.2.0"
            },
            "devDependencies": {
              "jest": "^29.7.0",
              "supertest": "^7.0.0"
            }
          }
          EOF

          cat > js/vendor-connector/src/firmwarePolicy.js <<'EOF'
          export function canUpdate(nowLocal, window){
            const [from, to] = window.split("-");
            const [nh, nm] = nowLocal.split(":").map(Number);
            const [fh, fm] = from.split(":").map(Number);
            const [th, tm] = to.split(":").map(Number);
            const now = nh*60+nm, f = fh*60+fm, t = th*60+tm;
            if (f <= t) return now >= f && now <= t;
            return now >= f || now <= t;
          }
          export function semverCmp(a,b){
            const pa=a.split('.').map(Number), pb=b.split('.').map(Number);
            for (let i=0;i<3;i++){ if (pa[i]!==pb[i]) return pa[i]-pb[i]; }
            return 0;
          }
          EOF

          cat > js/vendor-connector/src/index.js <<'EOF'
          import Fastify from "fastify";
          import { Registry, collectDefaultMetrics, Histogram } from "prom-client";
          import { canUpdate } from "./firmwarePolicy.js";

          const app = Fastify({ logger: true });
          const registry = new Registry();
          collectDefaultMetrics({ register: registry });
          const httpLatency = new Histogram({
            name: "http_request_duration_seconds",
            help: "HTTP latency",
            labelNames: ["route","method","status"],
            buckets: [0.01,0.025,0.05,0.1,0.25,0.5,1,2,5],
            registers: [registry]
          });

          app.addHook("onResponse", async (req, reply) => {
            const ms = reply.getResponseTime?.() ?? 0;
            httpLatency.labels(req.routerPath || req.url, req.method, String(reply.statusCode)).observe(ms/1000);
          });

          app.get("/health/live", async () => ({ status: "ok" }));
          app.get("/health/ready", async () => ({ status: "ok" }));
          app.get("/metrics", async (req, reply) => {
            reply.header("Content-Type", registry.contentType);
            reply.send(await registry.metrics());
          });
          app.get("/firmware/can-update", async (req) => {
            const now = req.query.now || "03:30";
            const window = req.query.window || "22:00-04:00";
            return { canUpdate: canUpdate(now, window) };
          });

          const port = Number(process.env.PORT || 8082);
          app.listen({ port, host: "0.0.0.0" });
          EOF

          cat > js/vendor-connector/test/firmwarePolicy.test.js <<'EOF'
          import { canUpdate, semverCmp } from "../src/firmwarePolicy.js";

          test("window across midnight", () => {
            expect(canUpdate("03:30","22:00-04:00")).toBe(true);
            expect(canUpdate("21:59","22:00-04:00")).toBe(false);
          });
          test("semver compare", () => {
            expect(semverCmp("1.2.10","1.2.9")).toBeGreaterThan(0);
            expect(semverCmp("1.2.0","1.2.0")).toBe(0);
            expect(semverCmp("1.2.0","1.3.0")).toBeLessThan(0);
          });
          EOF

          cat > js/vendor-connector/Dockerfile <<'EOF'
          FROM node:20-alpine
          WORKDIR /app
          COPY package.json ./
          RUN npm install --omit=dev
          COPY src ./src
          EXPOSE 8082
          CMD ["node","src/index.js"]
          EOF

          # CI workflow (runs on pushes/PRs)
          cat > .github/workflows/ci.yml <<'EOF'
          name: CI
          on:
            push:
              branches: [ main ]
            pull_request:
          jobs:
            build-test:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4

                - uses: actions/setup-dotnet@v4
                  with:
                    dotnet-version: 8.0.x

                - uses: actions/setup-java@v4
                  with:
                    distribution: temurin
                    java-version: '21'

                - uses: actions/setup-node@v4
                  with:
                    node-version: '20'

                - name: C# unit/integration
                  run: |
                    dotnet restore csharp/src/VendorConnector
                    dotnet build csharp/src/VendorConnector -c Release
                    dotnet test csharp/tests/Unit --logger "trx;LogFileName=unit.trx"
                    dotnet test csharp/tests/Integration --logger "trx;LogFileName=integration.trx"

                - name: Java tests
                  run: mvn -q -f java/vendor-connector/pom.xml test

                - name: JS tests
                  working-directory: js/vendor-connector
                  run: |
                    npm install
                    npm test

                - name: Build services (Docker)
                  run: docker compose build

                - name: Run services (Docker)
                  run: docker compose up -d csharp java js

                - name: Cross-service integration tests
                  working-directory: tests/integration
                  run: |
                    npm install
                    npm test

                - name: Docker logs on failure
                  if: failure()
                  run: |
                    docker compose ps
                    docker compose logs --no-color > tests_logs.txt

                - name: Upload logs
                  if: failure()
                  uses: actions/upload-artifact@v4
                  with:
                    name: docker-logs
                    path: tests_logs.txt
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Bootstrap repository content (multi-lang services, tests, docker-compose, monitoring, OpenAPI, CI)" || echo "No changes"
          git push
